#!/usr/bin/env bash

set -euo pipefail
set -x

if [ $(id -u) == 0 ]; then
	echo fatal: cannot be run as root >&2
	exit 1
fi

function start_and_link_app() {
	desktop_file=$1.desktop
	$desktop_file_full=/usr/share/applications/$desktop_file

	if ! test -e $desktop_file_full; then
		sudo ln -s $desktop_file_full /etc/xdg/autostart
	fi

	nohup gio launch $desktop_file_full >/dev/null 2>&1
}

if [ $1 == obs ]; then
	# TODO provision RTMP keys
	start_and_link_app com.obsproject.Studio
elif [ $1 == nextcloud ]; then
	nextcloud --userid 2024laptops --apppassword "$(jq .nextcloudAppPassword < /var/lib/seagl/config-data.json)" --isvfsenabled 0 --serverurl 'https://cloud.seagl.org/'
	start_and_link_app com.nextcloud.desktopclient.nextcloud
elif [ $1 == firefox ]; then
	sudo sed -i "s;AV_TEST_RESULTS_PLACEHOLDER;$(jq .avTestResultsSheetURL < /var/lib/seagl/config-data.json);" /etc/firefox/policies/policies.json
	start_and_link_app org.mozilla.firefox
else
	echo fatal: application to be set up must be one of obs, nextcloud, firefox
fi
