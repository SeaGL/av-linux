#!/usr/bin/env bash

set -euo pipefail
set -x

# XXX this doesn't work if the user actually *explicitly* passes empty string, i.e.
# seagl-setup-app ''
arg="${1-empty string}"

if [ $(id -u) == 0 ]; then
	echo fatal: cannot be run as root >&2
	exit 1
fi

function start_and_link_app() {
	desktop_file=$1.desktop
	desktop_file_full=/usr/share/applications/$desktop_file
	if ! test -e $desktop_file_full; then
		desktop_file_full=/var/lib/flatpak/exports/share/applications/$desktop_file
	fi

	sudo ln -sf $desktop_file_full /etc/xdg/autostart

	nohup gio launch $desktop_file_full >/dev/null 2>&1
}

function get_config_value() {
	jq -r $1 < /var/lib/seagl/config-data.json
}

if [ "$arg" == obs ]; then
	rtmp_key=$(get_config_value .youtubeRtmpKey)
	sed -i "s/__YOUTUBE_STREAM_KEY__/$rtmp_key/" ~/.var/app/com.obsproject.Studio/config/obs-studio/basic/profiles/seagl_live/service.json
	start_and_link_app com.obsproject.Studio
elif [ "$arg" == nextcloud ]; then
	nextcloud --userid $(date +%Y)laptops --apppassword "$(get_config_value .nextcloudAppPassword)" --isvfsenabled 0 --serverurl 'https://cloud.seagl.org/'  --localdirpath /home/seagloperator/Nextcloud
	sleep 10
	start_and_link_app com.nextcloud.desktopclient.nextcloud
elif [ "$arg" == firefox ]; then
	sudo sed -i "s;AV_TEST_RESULTS_PLACEHOLDER;$(get_config_value .avTestResultsSheetURL);" /etc/firefox/policies/policies.json
	sudo sed -i "s;__ATTEND_PORTAL_CREDENTIALS__=t;userId=%40$(get_config_value .matrixCredentials.user)%3A$(date +%Y).seagl.org\&password=$(get_config_value .matrixCredentials.password);" /etc/firefox/policies/policies.json
	sudo sed -i "s;__REMOTE_SPEAKER_TALK_URLS_PLACEHOLDER__;$(get_config_value .remoteSpeakerJitsiURLs);" /etc/firefox/policies/policies.json
	sudo sed -i "s;__SCHEDULE_URL_PLACEHOLDER__;$(get_config_value .scheduleUrl);" /etc/firefox/policies/policies.json
	start_and_link_app org.mozilla.firefox
elif [ "$arg" == rclone ]; then
	rclone config create seagl_s3 s3 provider=AWS access_key_id="$(get_config_value .awsCreds.accessKey)" secret_access_key="$(get_config_value .awsCreds.secretAccessKey)" env_auth=false region=us-west-2 endpoint= location_constraint=us-west-2 acl=private
	# Do the exact same thing but with sudo, in case someone runs rclone from a root shell by mistake
	sudo rclone config create seagl_s3 s3 provider=AWS access_key_id="$(get_config_value .awsCreds.accessKey)" secret_access_key="$(get_config_value .awsCreds.secretAccessKey)" env_auth=false region=us-west-2 endpoint= location_constraint=us-west-2 acl=private
elif [ "$arg" == birdhoused ]; then
	systemctl --user enable --now seagl-birdhoused.service || true
	# TODO remove this hack
	echo 'You may see systemctl failures above. This is expected, because birdhoused will crash and restart until it can connect to the OBS WebSocket.'
	echo 'YOU SHOULD PROBABLY DOUBLE-CHECK THAT IT EVENTUALLY STARTED OK.'
elif [ "$arg" == zrok ]; then
	zrok enable $(get_config_value .zrokKey)
	systemctl --user enable --now seagl-zrok-share.service
elif [ "$arg" == aviaryui ]; then
	start_and_link_app org.seagl.AviaryUI
elif [ "$arg" == streamsprout ]; then
	rtmp_key=$(get_config_value .youtubeRtmpKey)
	peertube_rtmp_key=$(get_config_value .peertubeRtmpKey)
	sudo sed -i -e "s/__YOUTUBE_STREAM_KEY__/$rtmp_key/" -e "s/__PEERTUBE_STREAM_KEY__/$peertube_rtmp_key/" /etc/seagl/stream-sprout.yaml
	systemctl --user enable --now seagl-streamsprout.service
else
	echo fatal: application to be set up must be one of obs, nextcloud, firefox, rclone, birdhoused, aviaryui, streamsprout, or zrok, but received $arg 1>&2
	exit 1
fi
