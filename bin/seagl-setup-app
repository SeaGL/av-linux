#!/usr/bin/env bash

set -euo pipefail
set -x

# XXX this doesn't work if the user actually *explicitly* passes empty string, i.e.
# seagl-setup-app ''
arg="${1-empty string}"

if [ $(id -u) == 0 ]; then
	echo fatal: cannot be run as root >&2
	exit 1
fi

function start_and_link_app() {
	desktop_file=$1.desktop
	desktop_file_full=/usr/share/applications/$desktop_file
	if ! test -e $desktop_file_full; then
		desktop_file_full=/var/lib/flatpak/exports/share/applications/$desktop_file
	fi

	sudo ln -sf $desktop_file_full /etc/xdg/autostart

	nohup gio launch $desktop_file_full >/dev/null 2>&1
}

if [ "$arg" == obs ]; then
	# TODO provision RTMP keys
	start_and_link_app com.obsproject.Studio
elif [ "$arg" == nextcloud ]; then
	nextcloud --userid 2024laptops --apppassword "$(jq -r .nextcloudAppPassword < /var/lib/seagl/config-data.json)" --isvfsenabled 0 --serverurl 'https://cloud.seagl.org/'
	#start_and_link_app com.nextcloud.desktopclient.nextcloud
elif [ "$arg" == firefox ]; then
	sudo sed -i "s;AV_TEST_RESULTS_PLACEHOLDER;$(jq -r .avTestResultsSheetURL < /var/lib/seagl/config-data.json);" /etc/firefox/policies/policies.json
	start_and_link_app org.mozilla.firefox
else
	echo fatal: application to be set up must be one of obs, nextcloud, firefox, but received $arg
fi
