#!/usr/bin/env bash

set -euo pipefail
set -x

if ! [ $(id -u) == 0 ]; then
	exec sudo $0 "$@"
fi

# TODO figure out how to script age's password input, then cache the password here
curl https://seagl.org/av-linux/production.json.age > /var/lib/seagl/config-data.json.age
echo Decrypting laptop configuration data - you will be prompted for the password
while ! age --decrypt /var/lib/seagl/config-data.json.age > /var/lib/seagl/config-data.json.new; do
	true
done

# This script really should run ok noninteractively, but this Zenity call is ok
# because basically by definition, it only occurs at room setup. After that we just
# use the cached value.
if ! test -f /var/lib/seagl/room-id; then
	zenity --list --text='Which room is this?' --column=Room Lyceum 332 334 340 > /var/lib/seagl/room-id
fi

if test -e /var/lib/seagl/config-data.json; then
	diff --color=always /var/lib/seagl/config-data.json{,.new} || true
else
	echo | diff --color=always - /var/lib/seagl/config-data.json.new || true
fi

mv /var/lib/seagl/config-data.json{.new,}
rm /var/lib/seagl/config-data.json.age
