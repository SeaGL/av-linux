#!/usr/bin/env bash

set -euo pipefail
set -x

# This ensures that you can see error output when this script is autorun
trap bash ERR

if [ -e /var/lib/seagl/room-setup-complete ]; then
	exit 0
fi

sudo mkdir -p /var/lib/seagl
sudo chown -R seagloperator:seagloperator /var/lib/seagl

seagl-refresh-config

sudo hostnamectl location "$(sed -E 's/([[:digit:]])/Room \1/' < /var/lib/seagl/room-id)"

if zenity --question --text='Should this laptop be provisioned for streaming? Choose no if it will only be used for presentations.'; then
	echo streaming > /var/lib/seagl/laptop-type
else
	echo presentations > /var/lib/seagl/laptop-type
fi

sudo hostnamectl hostname seagl-$(tr '[:upper:] ' '[:lower:]-' < /var/lib/seagl/room-id)-$(cat /var/lib/seagl/laptop-type)

if [ $(cat /var/lib/seagl/laptop-type) == streaming ]; then
	# TODO add SeaGL-specific scripts into here
	gsettings set org.gnome.shell favorite-apps "['org.mozilla.firefox.desktop', 'org.gnome.Nautilus.desktop', 'org.gnome.Terminal.desktop', 'org.gnome.Software.desktop', 'com.nextcloud.desktopclient.nextcloud.desktop', 'com.obsproject.Studio.desktop']"
	seagl-setup-app nextcloud
	seagl-setup-app obs
	seagl-setup-app firefox
	seagl-setup-app rclone
	seagl-setup-app zrok
	seagl-setup-app aviaryui
	# XXX this is a hack
	sleep 20 # Do our best to avoid birdhoused startup crashes reported by systemd, though it'll be restarted so this is just cosmetic
	seagl-setup-app birdhoused
else
	seagl-setup-app nextcloud
fi

# For some reason, Toolbx wants to create a Fedora 38 container??
# TODO confirm this is an upstream bug, then report
yes | toolbox create --assumeyes --release f42

touch /var/lib/seagl/room-setup-complete

zenity --warning --text="Remember to check the room panel's volume\!"

echo Room setup complete. Dropping you into a shell.
# Mostly we do this so you can still read log messages after the script finishes, if it was started from a desktop file
bash
