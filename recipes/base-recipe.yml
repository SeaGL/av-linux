---
# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json
name: aviary-linux-base
description: SeaGL Aviary Linux (base software image)

base-image: ghcr.io/ublue-os/silverblue-main
image-version: 42

modules:
  - type: rpm-ostree
    install:
      # General system packages
      - jq
      - age
      - seahorse
      - gedit
      - cockpit
      # Streaming machine packages
      - obs-studio
      - obs-studio-plugin-vaapi
      - obs-studio-devel # TODO figure out how to remove this, it's needed to build OBS Source Record
      - cmake # Ditto
      - gcc-c++ # Ditto
      - mpv
      - yt-dlp
      - zenity
      - rclone
      - fuse-devel
      - cheese
      - nodejs
      - dbus-x11 # Without this, gsettings errors out trying to spawn `dbus-launch`
      # Presentation machine packages
      - libreoffice
      - nextcloud-client
      - nextcloud-client-nautilus
  - type: rpm-ostree
    repos:
      - https://copr.fedorainfracloud.org/coprs/tarulia/obs-studio-plugins/repo/fedora-%OS_VERSION%/tarulia-obs-studio-plugins-fedora-%OS_VERSION%.repo
    install:
      - obs-studio-plugin-advanced-scene-switcher
  - type: script
    snippets:
      - cd /tmp &&
        git clone --branch 0.4.6 https://github.com/exeldro/obs-source-record.git &&
        cd obs-source-record/ &&
        cmake -S . -B build -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_OUT_OF_TREE=On && cmake --build build &&
        cd build &&
        sudo make install &&
        sudo mv /usr/lib/obs-plugins/source-record.so /usr/lib64/obs-plugins # TODO figure out how to not do this
  # This is early and targeted so that we can install Zrok in lower layers,
  # but not invalidate larger lower layers whenever anything in /etc changes
  - type: files
    files:
      - source: etc/yum.repos.d
        destination: /etc/yum.repos.d
  - type: rpm-ostree
    # repos:
    #   - https://packages.openziti.org/zitipax-openziti-rpm-stable/redhat/x86_64/
    keys:
      - https://packages.openziti.org/zitipax-openziti-rpm-stable/redhat/x86_64/repodata/repomd.xml.key
    install:
      - zrok
    optfix:
      - openziti
  - type: gnome-extensions
    install:
      - 6433 # App menu is back
      - 5410 # Grand Theft Focus

  - type: signing

